<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó ToAgro</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #2c5530;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, button {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #2c5530;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #1e3a21;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .coords {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #2c5530;
            background-color: #f8f9fa;
        }
        .tab-content {
            display: none;
            padding: 20px 0;
        }
        .tab-content.active {
            display: block;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöú ToAgro - –¢–µ—Å—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó</h1>
        <p>–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω—å –∑ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—î—é</p>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('test')">–¢–µ—Å—Ç–æ–≤–∏–π endpoint</button>
            <button class="tab" onclick="showTab('listing')">–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
        </div>

        <!-- –¢–µ—Å—Ç–æ–≤–∏–π endpoint -->
        <div id="test" class="tab-content active">
            <h2>–¢–µ—Å—Ç–æ–≤–∏–π endpoint</h2>
            <form id="testForm">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞ —Ç–µ—Å—Ç—É:</label>
                    <input type="text" id="testTitle" value="–¢–µ—Å—Ç –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó">
                </div>
                
                <div class="form-group">
                    <button type="button" onclick="getLocation()">üåç –û—Ç—Ä–∏–º–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é</button>
                    <div id="locationStatus" class="coords" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label>–î–∞–Ω—ñ –∑ –∫–∞—Ä—Ç–∏ (JSON):</label>
                    <textarea id="mapLocation" rows="6" placeholder='{"lat": "50.4501", "lon": "30.5234", "name": "–ö–∏—ó–≤"}'></textarea>
                </div>

                <button type="submit">üß™ –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ç–µ—Å—Ç</button>
            </form>
            <div id="testResponse" class="response" style="display: none;"></div>
        </div>

        <!-- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è -->
        <div id="listing" class="tab-content">
            <h2>–°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
            <form id="listingForm">
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è:</label>
                    <input type="text" id="listingTitle" value="–¢—Ä–∞–∫—Ç–æ—Ä John Deere" required>
                </div>
                
                <div class="form-group">
                    <label>–û–ø–∏—Å:</label>
                    <textarea id="description" rows="3" required>–í—ñ–¥–º—ñ–Ω–Ω–∏–π —Ç—Ä–∞–∫—Ç–æ—Ä –≤ –≥–∞—Ä–Ω–æ–º—É —Å—Ç–∞–Ω—ñ</textarea>
                </div>

                <div class="form-group">
                    <label>–¶—ñ–Ω–∞ (UAH):</label>
                    <input type="number" id="price" value="50000" required>
                </div>

                <div class="form-group">
                    <label>ID –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:</label>
                    <input type="number" id="categoryId" value="1" required>
                </div>

                <div class="form-group">
                    <button type="button" onclick="getLocationForListing()">üåç –û—Ç—Ä–∏–º–∞—Ç–∏ –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—é</button>
                    <div id="listingLocationStatus" class="coords" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label>–î–∞–Ω—ñ –∑ –∫–∞—Ä—Ç–∏ (JSON, –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <textarea id="listingMapLocation" rows="4" placeholder='{"lat": "50.4501", "lon": "30.5234", "name": "–ö–∏—ó–≤"}'></textarea>
                </div>

                <div class="form-group">
                    <label>–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è:</label>
                    <input type="file" id="images" multiple accept="image/*">
                </div>

                <button type="submit">üöú –°—Ç–≤–æ—Ä–∏—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
            </form>
            <div id="listingResponse" class="response" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        let userGeolocation = null;

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è —Ç–∞–±—ñ–≤
        function showTab(tabName) {
            // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ —Ç–∞–±–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ –≤–∏–±—Ä–∞–Ω–∏–π —Ç–∞–±
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó
        function getLocation() {
            const status = document.getElementById('locationStatus');
            status.style.display = 'block';
            status.innerHTML = 'üîÑ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó...';
            status.className = 'coords';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userGeolocation = {
                            latitude: position.coords.latitude.toString(),
                            longitude: position.coords.longitude.toString(),
                            accuracy: position.coords.accuracy
                        };
                        
                        status.innerHTML = `‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∞:<br>–®–∏—Ä–æ—Ç–∞: ${userGeolocation.latitude}<br>–î–æ–≤–≥–æ—Ç–∞: ${userGeolocation.longitude}<br>–¢–æ—á–Ω—ñ—Å—Ç—å: ${userGeolocation.accuracy}–º`;
                        status.className = 'coords status success';
                    },
                    function(error) {
                        status.innerHTML = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                        status.className = 'coords status error';
                    }
                );
            } else {
                status.innerHTML = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º';
                status.className = 'coords status error';
            }
        }

        function getLocationForListing() {
            const status = document.getElementById('listingLocationStatus');
            status.style.display = 'block';
            status.innerHTML = 'üîÑ –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≥–µ–æ–ª–æ–∫–∞—Ü—ñ—ó...';
            status.className = 'coords';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userGeolocation = {
                            latitude: position.coords.latitude.toString(),
                            longitude: position.coords.longitude.toString(),
                            accuracy: position.coords.accuracy
                        };
                        
                        status.innerHTML = `‚úÖ –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–∞:<br>–®–∏—Ä–æ—Ç–∞: ${userGeolocation.latitude}<br>–î–æ–≤–≥–æ—Ç–∞: ${userGeolocation.longitude}<br>–¢–æ—á–Ω—ñ—Å—Ç—å: ${userGeolocation.accuracy}–º`;
                        status.className = 'coords status success';
                    },
                    function(error) {
                        status.innerHTML = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
                        status.className = 'coords status error';
                    }
                );
            } else {
                status.innerHTML = '‚ùå –ì–µ–æ–ª–æ–∫–∞—Ü—ñ—è –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º';
                status.className = 'coords status error';
            }
        }

        // –¢–µ—Å—Ç–æ–≤–∏–π –∑–∞–ø–∏—Ç
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const responseDiv = document.getElementById('testResponse');
            responseDiv.style.display = 'block';
            responseDiv.textContent = 'üîÑ –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–∞–ø–∏—Ç—É...';

            const formData = new FormData();
            formData.append('title', document.getElementById('testTitle').value);
            
            if (userGeolocation) {
                formData.append('userGeolocation', JSON.stringify(userGeolocation));
            }
            
            const mapLocation = document.getElementById('mapLocation').value.trim();
            if (mapLocation) {
                try {
                    JSON.parse(mapLocation); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ JSON
                    formData.append('mapLocation', mapLocation);
                } catch (e) {
                    responseDiv.textContent = '‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π JSON –≤ –ø–æ–ª—ñ "–î–∞–Ω—ñ –∑ –∫–∞—Ä—Ç–∏"';
                    return;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/test/geolocation`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                responseDiv.textContent = `Status: ${response.status}\n\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                responseDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
            }
        });

        // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
        document.getElementById('listingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const responseDiv = document.getElementById('listingResponse');
            responseDiv.style.display = 'block';
            responseDiv.textContent = 'üîÑ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è...';

            const formData = new FormData();
            formData.append('title', document.getElementById('listingTitle').value);
            formData.append('description', document.getElementById('description').value);
            formData.append('price', document.getElementById('price').value);
            formData.append('currency', 'UAH');
            formData.append('categoryId', document.getElementById('categoryId').value);
            formData.append('category', 'agricultural_machinery');
            formData.append('condition', 'used');
            
            if (userGeolocation) {
                formData.append('userGeolocation', JSON.stringify(userGeolocation));
            }
            
            const mapLocation = document.getElementById('listingMapLocation').value.trim();
            if (mapLocation) {
                try {
                    JSON.parse(mapLocation); // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞–ª—ñ–¥–Ω–æ—Å—Ç—ñ JSON
                    formData.append('mapLocation', mapLocation);
                } catch (e) {
                    responseDiv.textContent = '‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π JSON –≤ –ø–æ–ª—ñ "–î–∞–Ω—ñ –∑ –∫–∞—Ä—Ç–∏"';
                    return;
                }
            }

            // –î–æ–¥–∞–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤
            const files = document.getElementById('images').files;
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }

            try {
                const response = await fetch(`${API_BASE}/listings`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                responseDiv.textContent = `Status: ${response.status}\n\n${JSON.stringify(result, null, 2)}`;
            } catch (error) {
                responseDiv.textContent = `‚ùå –ü–æ–º–∏–ª–∫–∞: ${error.message}`;
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –ø—Ä–∏–∫–ª–∞–¥ –¥–∞–Ω–∏—Ö –∫–∞—Ä—Ç–∏
        document.getElementById('mapLocation').value = JSON.stringify({
            "lat": "50.4501",
            "lon": "30.5234",
            "name": "–ö–∏—ó–≤",
            "display_name": "–ö–∏—ó–≤, –£–∫—Ä–∞—ó–Ω–∞",
            "osm_id": 421866,
            "address": {
                "city": "–ö–∏—ó–≤",
                "state": "–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
                "country": "–£–∫—Ä–∞—ó–Ω–∞"
            }
        }, null, 2);

        document.getElementById('listingMapLocation').value = JSON.stringify({
            "lat": "49.2331",
            "lon": "28.4682",
            "name": "–í—ñ–Ω–Ω–∏—Ü—è",
            "display_name": "–í—ñ–Ω–Ω–∏—Ü—è, –í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å, –£–∫—Ä–∞—ó–Ω–∞",
            "osm_id": 1234567,
            "address": {
                "city": "–í—ñ–Ω–Ω–∏—Ü—è",
                "state": "–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å",
                "country": "–£–∫—Ä–∞—ó–Ω–∞"
            }
        }, null, 2);
    </script>
</body>
</html>
